@page "/admin/booking"
@inject IJSRuntime JS
@using HotelManagementSystem_Web.Layout.AdminLayout
@layout AdminLayout
@using System.ComponentModel.DataAnnotations
@inject HttpClient _httpClient


<h3 class="text-center mb-4" style="color: #e60000;">Bookings Management</h3>


<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex gap-2">
        <select class="form-select" @bind="selectedStatus">
            <option value="">Select Booking Status</option>
            <option value="Booked">Booked</option>
            <option value="Cancelled">Cancelled</option>
        </select>
        <button class="btn btn-danger" @onclick="ApplyFilter">Filter</button>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-danger" @onclick="ToggleActionColumn">
            <i class="bi bi-pencil"></i> Edit
        </button>
        <button class="btn btn-danger" @onclick="ShowAddBookingModal">+ Add Booking</button>
    </div>
</div>

<!-- Booking Table -->
<table class="table table-bordered align-middle" style="background-color: #fff0f0;">
    <thead style="background-color: #ffe6e6;">
    <tr>
        <th class="ps-2">Name</th>
        <th class="ps-2">NRC</th>
        <th class="ps-2">Phone No</th>
        <th class="ps-2">Guest Count</th>
        <th class="ps-2">Check In</th>
        <th class="ps-2">Check Out</th>
        <th class="ps-2">Deposit Amount</th>
        <th class="ps-2">Booking Status</th>
        <th class="ps-2">Total Amount</th>
        <th class="ps-2">Payment Type</th>
        @if (showActionColumn)
        {
            <th class="text-center">Actions</th>
        }
    </tr>
    </thead>
    <tbody style="background-color: white;">
    @foreach (var booking in filteredBookings.Skip((currentPage - 1) * pageSize).Take(pageSize))
    {
        <tr>
            <td class="ps-2">@booking.Name</td>
            <td class="ps-2">@booking.Nrc</td>
            <td class="ps-2">@booking.PhoneNo</td>
            <td class="ps-2">@booking.GuestCount</td>
            <td class="ps-2">@booking.CheckInTime?.ToShortDateString()</td>
            <td class="ps-2">@booking.CheckOutTime?.ToShortDateString()</td>
            <td class="ps-2">@booking.DepositAmount</td>
            <td class="ps-2">@booking.BookingStatus</td>
            <td class="ps-2">@booking.TotalAmount</td>
            <td class="ps-2">@booking.PaymentType</td>
            @if (showActionColumn)
            {
                <td class="text-center">
                    <button class="btn btn-outline-info btn-sm py-1 me-2">
                        Reserve
                    </button>
                    <button class="btn btn-outline-primary btn-sm py-1 me-2">
                        Edit
                    </button>
                    <button class="btn btn-outline-danger btn-sm py-1">
                        Delete
                    </button>
                </td>
            }
        </tr>
    }
    </tbody>
</table>

<!-- Pagination -->
<div class="d-flex justify-content-between align-items-center mt-3">
    <button class="btn btn-light" @onclick="PreviousPage" disabled="@(!CanGoBack)">Previous</button>
    <span>Page @currentPage of @totalPages</span>
    <button class="btn btn-light" @onclick="NextPage" disabled="@(!CanGoForward)">Next</button>
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" style="margin-top: 52px;">
    <div class="modal-dialog">
        <div class="modal-content">
            <EditForm class="edit-form" Model="_model" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator/>
                <div class="modal-header">
                    <h5 class="modal-title" id="bookingModalLabel">
                        @(_model?.UserId == null || _model.UserId == Guid.Empty
                            ? "AddBooking"
                            : "EditBooking")
                    </h5>
                    <button type="button" class="btn-close" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ValidationSummary/>
                    <input type="hidden" @bind="_model.UserId"/>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label mb-1">Name</label>
                            <input type="text" class="form-control" placeholder="Name ..." @bind="_model.Name"/>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label mb-1">NRC</label>
                            <input type="text" class="form-control" placeholder="12/XXX(N)XXXXXX" @bind="_model.Nrc"/>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label mb-1">Phone Number</label>
                            <input type="text" class="form-control" placeholder="09-XXXXXXXXXX"
                                   @bind="_model.PhoneNo"/>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label mb-1">Guest Count</label>
                            <input type="number" class="form-control" placeholder="Guest Count"
                                   @bind="_model.GuestCount"/>
                        </div>

                        <div class="col-12 mb-3">
                            <label class="form-label" >Add Room</label>
                            <select class="form-select" @onchange="OnRoomTypeChanged">
                                <option value="" >Please Choose One If Room Add</option>
                                @foreach (var roomType in roomTypes)
                                {
                                    <option value="@roomType.RoomTypeId">@roomType.RoomTypeName</option>
                                }
                            </select>
                        </div>


                        <div class="col-md-6 mb-3">
                            <label class="form-label mb-1">Check In</label>
                            <input type="date" class="form-control" @bind="_model.CheckInTime"/>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label mb-1">Check Out</label>
                            <input type="date" class="form-control" @bind="_model.CheckOutTime"/>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label mb-1">Booking Status</label>
                            <select class="form-control" @bind="_model.BookingStatus">
                                <option value="Booked">Booked</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label mb-1">Payment Type</label>
                            <select class="form-control" @bind="_model.PaymentType">
                                <option value="">Please Choose One</option>
                                <option value="Mobile Banking">Mobile Banking</option>
                                <option value="Card">Card</option>
                                <option value="Cash">Cash</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label mb-1">Deposit Amount</label>
                            <input type="number" class="form-control" placeholder="Deposit Amount"
                                   @bind="_model.DepositAmount"/>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label mb-1">Total Amount</label>
                            <input type="number" class="form-control" placeholder="Total Amount"
                                   @bind="_model.TotalAmount"/>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-danger">Create</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>
